<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://axelv.github.io/atticus-calculator/index.js"></script>
    <title>Charlson Comorbidity Index</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <div
      class="min-h-full flex items-center justify-center py-12 px-10 sm:px-6 lg:px-8"
    >
      <div class="sm:max-w-md w-full space-y-8">
        <div>
          <h1 class="mt-6 text-center text-3xl font-bold text-blue-700">
            Charlson Comorbidity Index
          </h1>
        </div>

        <form
          id="calculator"
          class="rounded-md"
          oninput="
          cci_result = parseInt(age.value)
              +parseInt(mi.value)
              +parseInt(chf.value)
              +parseInt(pvd.value)
              +parseInt(cvatia.value)
              +parseInt(dementia.value)
              +parseInt(copd.value)
              +parseInt(ctd.value)
              +parseInt(pud.value)
              +parseInt(ld.value)
              +parseInt(diabetes.value)
              +parseInt(hemi.value)
              +parseInt(ckd.value)
              +parseInt(tumor.value) 
              +parseInt(leukemia.value)
              +parseInt(lymphoma.value)
              +parseInt(aids.value)
          if(isNaN(cci_result)){cci.value = '... points'}
            else if (cci_result=='1'){cci.value = cci_result + ' point'}
            else{cci.value = cci_result + ' points'}

          exp=Math.exp(cci_result*0.9)
          survival_result=Math.pow(0.983, exp)*100
          if(isNaN(survival_result)){survival.value = '... %'}
            else if (survival_result<'0.0000001') {survival.value = '0 %'}
            else{survival.value = survival_result.toPrecision(2) + '%'}
          "
        >
          <div class="col-span-6 sm:col-span-3 lg:col-span-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Age:
            </label>
            <select
              class="t-1 block shadow-sm sm:text-base border-gray-300 rounded-md"
              as="select"
              name="age"
              value="0"
            >
              <option selected="selected" value="0">&#60;50 years</option>
              <option value="1">50-59 years</option>
              <option value="2">60-69 years</option>
              <option value="3">70-79 years</option>
              <option value="4">â‰¥80 years</option>
            </select>
          </div>

          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Myocardial infarction:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="mi"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="mi"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>

          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              CHF:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="chf"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="chf"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>

          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Peripheral vascular disease:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="pvd"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="pvd"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>

          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              CVA or TIA:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="cvatia"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="cvatia"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Dementia:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="dementia"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="dementia"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              COPD:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="copd"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="copd"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Connective tissue disease:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ctd"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ctd"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Peptic ulcer disease:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="pud"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="pud"
              value="1"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Liver disease:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ld"
              value="0"
              checked="checked"
            /><label class="mx-1">None</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ld"
              value="1"
            /><label class="mx-1">Mild</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ld"
              value="2"
            /><label class="mx-1">Moderate to severe</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Diabetes mellitus:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="diabetes"
              value="0"
              checked="checked"
            /><label class="mx-1">None/diet-controlled</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="diabetes"
              value="1"
            />
            <label class="mx-1">Uncomplicated</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="diabetes"
              value="2"
            />
            <label class="mx-1">End-organ damage</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Hemiplegia:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="hemi"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="hemi"
              value="2"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Moderate to severe CKD:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ckd"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="ckd"
              value="2"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Solid tumor:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="tumor"
              value="0"
              checked="checked"
            /><label class="mx-1">None/diet-controlled</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="tumor"
              value="2"
            /><label class="mx-1">Localized</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="tumor"
              value="6"
            /><label class="mx-1">Metastatic</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              Leukemia:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="leukemia"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="leukemia"
              value="2"
            /><label class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <div class="text-base sm:text-sm font-medium text-gray-700">
              Lymphoma:
            </div>
            <input
              class="rounded text-blue-700"
              type="radio"
              id="lymphoma-no"
              name="lymphoma"
              value="0"
              checked="checked"
            /><label for="lymphoma-no" class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              id="lymphoma-yes"
              name="lymphoma"
              value="2"
            /><label for="lymphoma-yes" class="mx-1">Yes</label>
          </div>
          <div class="mt-2">
            <label class="block text-base sm:text-sm font-medium text-gray-700">
              AIDS:
            </label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="aids"
              value="0"
              checked="checked"
            /><label class="mx-1">No</label>
            <input
              class="rounded text-blue-700"
              type="radio"
              name="aids"
              value="6"
            /><label class="mx-1">Yes</label>
          </div>
          <p>&nbsp;</p>
          <div class="col-span-6 sm:col-span-3 lg:col-span-2 block">
            <label class="block font-bold text-gray-700"
              >Charlson Comorbidity Index:</label
            >
            <output
              name="cci"
              class="block w-fit text-2xl text-center items-center justify-center px-5 py-3 border border-transparent font-medium rounded-md text-blue-700 bg-indigo-50 hover:bg-indigo-300"
            />
          </div>
          <div class="col-span-6 sm:col-span-3 lg:col-span-2 block">
            <label class="block font-bold text-gray-700"
              >Estimated 10-year survival:</label
            >
            <output
              name="survival"
              class="block w-fit text-2xl text-center items-center justify-center px-5 py-3 border border-transparent font-medium rounded-md text-blue-700 bg-indigo-50 hover:bg-indigo-300"
            />
          </div>
          <button>Test submit</button>
        </form>
      </div>
    </div>
    <script>
      $(document).ready(function () {
        console.debug("1. Connecting calculator...");
        makeCalculatorV2(
          "calculator",
          function (data) {
            /**
             * The object bellow is the Observation instance that will be sent back to Cicero
             **/
            const observation = {
              resourceType: "Observation",
              code: {
                text: "Charlson Comorbidity Index",
                coding: [
                  {
                    display: "Charlson Comorbidity Index",
                    code: "762713009",
                    system: "http://snomed.info/sct",
                  },
                ],
              },
              valueQuantity: {
                value: cci_result,
                unit: "points",
                code: "281850001",
                system: "http://snomed.info/sct",
              },
            };
            console.debug(observation);
            return observation;
          },
          { autoSave: true }
        );
        console.debug("2. Calculator setup done.");
      });
    </script>
  </body>
</html>
